<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Readme Â· NonPromoting.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link href="assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>NonPromoting.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li class="current"><a class="toctext" href>Readme</a><ul class="internal"><li class="toplevel"><a class="toctext" href="#Overview-1">Overview</a></li><li class="toplevel"><a class="toctext" href="#Design-1">Design</a></li></ul></li><li><a class="toctext" href="autodocs/">Docstrings</a></li></ul></nav><article id="docs"><header><nav><ul><li><a href>Readme</a></li></ul></nav><hr/><div id="topbar"><span>Readme</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="[NonPromoting](https://github.com/eschnett/NonPromoting)-1" href="#[NonPromoting](https://github.com/eschnett/NonPromoting)-1"><a href="https://github.com/eschnett/NonPromoting">NonPromoting</a></a></h1><p>A Julia library for non-promoting type wrappers, i.e. for arithmetic types that do not get automatically promoted to other types. This can help prevent subtle type errors</p><p><a href="https://travis-ci.org/eschnett/NonPromoting.jl"><img src="https://travis-ci.org/eschnett/NonPromoting.jl.svg?branch=master" alt="Build Status (Travis)"/></a> <a href="https://ci.appveyor.com/project/eschnett/nonpromoting-jl/branch/master"><img src="https://ci.appveyor.com/api/projects/status/m1rl6v9dgngsbeee?svg=true" alt="Build status (Appveyor)"/></a> <a href="https://coveralls.io/github/eschnett/NonPromoting.jl?branch=master"><img src="https://coveralls.io/repos/github/eschnett/NonPromoting.jl/badge.svg?branch=master" alt="Coverage Status (Coveralls)"/></a></p><h1><a class="nav-anchor" id="Overview-1" href="#Overview-1">Overview</a></h1><p>Sometimes, Julia&#39;s automatic type promotion gets things subtly wrong. This is especially a problem if you want a precision higher than <code>Float64</code>, since <code>Float64</code> is often the default go-to type when a floating point number is generated from non-floating-point numbers.</p><p>Here is an example. Of course, this code is so simple that one can spot the problem right away. If multiple modules are involved, then spotting this isn&#39;t that easy any more.</p><pre><code class="language-Julia">function pi_plus_tenth_bad()
    x = big(pi)   # highly accurate
    y = 1/10      # unintentionally inaccurate
    x + y
end</code></pre><p>The problem here is that the expression <code>1/10</code> has type <code>Float64</code>, which is much less accurate than <code>BigFloat</code>. The error is difficult to spot since the type <code>Float64</code> is not mentioned explicitly. <code>Float64</code> just happens to be the default type that Julia chooses when dividing two integers.</p><p>This version of the code does not have a problem:</p><pre><code class="language-Julia">function pi_plus_tenth()
    x = big(pi)   # highly accurate
    y = 1//10     # infinitely accurate
    x + y
end</code></pre><p>This uses a rational number to represent the fraction <code>1/10</code>, which is arbitrarily accurate when converted to <code>BigFloat</code>.</p><p>One way to avoid such surprises is by avoiding automatic type promotion. If the compiler refuses the expression <code>+(::BigFloat, ::Float64)</code>, then the error is quickly detected.</p><h1><a class="nav-anchor" id="Design-1" href="#Design-1">Design</a></h1><p>The module <code>NonPromoting</code> defines a wrapper type <code>NP{T}</code>. <code>T</code> is expected to be a subtype of <code>AbstractFloat</code> such as <code>Float64</code>, <code>BigFloat</code>, etc. This type supports all operations that <code>T</code> supports, except that the automatic promotion rules to and from <code>T</code> are disabled. Julia is very efficient for this kind of setup, and there is zero run-time overhead.</p><p>To make a value non-promotable, call the constructor <code>NP{T}</code>. To extract the value, convert it back to <code>T</code> with <code>convert(T, x)</code>. The usual arithmetic operations (add, subtract, multiply, square root, trigonometric functions, ...) are supported directly on the <code>NP{T}</code> type.</p><p>The first (inaccurate) code looks like this:</p><pre><code class="language-Julia">using NonPromoting
function pi_plus_tenth_bad()
    x = NP(big(pi))   # highly accurate
    y = NP(1/10)      # unintentionally inaccurate
    x + y             # ERROR REPORTED HERE
end</code></pre><p>This code will now produce an error, because the addition <code>+(::NP{BigFloat}, NP{Float64})</code> is not defined, and Julia will not promote <code>NP{Float64}</code> to <code>NP{BigFloat}</code>.</p><p>This version is explicit about types and works correctly (i.e. accurately):</p><pre><code class="language-Julia">using NonPromoting
function pi_plus_tenth()
    x = NP{BigFloat}(pi)      # highly accurate
    y = NP{BigFloat}(1//10)   # also highly accurate
    x + y
end</code></pre><p>The basic design idea is that one uses the type <code>NP{T}</code> instead of <code>T</code> everywhere, except to interface with other modules who do not know about <code>NonPromoting</code>.</p><footer><hr/><a class="next" href="autodocs/"><span class="direction">Next</span><span class="title">Docstrings</span></a></footer></article></body></html>
