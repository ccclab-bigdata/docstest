<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Setup a Test Stack Â· CloudWatchLogs.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link href="../../assets/documenter.css" rel="stylesheet" type="text/css"/><link href="../../assets/invenia.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><a href="../../index.html"><img class="logo" src="../../assets/logo.png" alt="CloudWatchLogs.jl logo"/></a><h1>CloudWatchLogs.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../../">Home</a></li><li><a class="toctext" href="../api/">API</a></li><li class="current"><a class="toctext" href>Setup a Test Stack</a><ul class="internal"><li><a class="toctext" href="#Prerequisites-1">Prerequisites</a></li><li><a class="toctext" href="#Setting-up-the-Account-1">Setting up the Account</a></li><li><a class="toctext" href="#Creating-the-Stack-1">Creating the Stack</a></li></ul></li></ul></nav><article id="docs"><header><nav><ul><li><a href>Setup a Test Stack</a></li></ul></nav><hr/><div id="topbar"><span>Setup a Test Stack</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="Setting-up-a-Test-Environment-1" href="#Setting-up-a-Test-Environment-1">Setting up a Test Environment</a></h1><h2><a class="nav-anchor" id="Prerequisites-1" href="#Prerequisites-1">Prerequisites</a></h2><p>You must have an AWS account. Setting up the test stack will require permissions for IAM, CloudFormation, and CloudWatch Logs.</p><p>The instructions below will sometimes use the <a href="https://aws.amazon.com/cli/">AWS CLI</a>.</p><p>At Invenia we have a dedicated account for public CI, so the actions below are performed with an administrator role in that account.</p><h2><a class="nav-anchor" id="Setting-up-the-Account-1" href="#Setting-up-the-Account-1">Setting up the Account</a></h2><p>These are manual steps to take when setting up the testing account.</p><h3><a class="nav-anchor" id="Create-a-Testing-User-1" href="#Create-a-Testing-User-1">Create a Testing User</a></h3><p>This user will be responsible for actually running the tests. The user will be passed to CloudFormation on stack creation and given permission to assume the stack&#39;s testing role. This approach allows the same user to be used for multiple testing stacks in the same account, which is useful for iterating on stack design.</p><p>Since the user is given permissions by CloudFormation, it needs no permissions at creation time. It will, however, need access keys. Save these for running tests, ideally as a profile in your <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-config-files.html">AWS credentials file</a>.</p><p>At Invenia, we create a user dedicated to the project, in this case called <code>CloudWatchLogsJL</code>.</p><h3><a class="nav-anchor" id="Create-a-Dedicated-Stack-Creation-Role-(Optional)-1" href="#Create-a-Dedicated-Stack-Creation-Role-(Optional)-1">Create a Dedicated Stack Creation Role (Optional)</a></h3><p>If you wish to have greater control and visibility over stack creation, create a dedicated administrator role which will manage the creation of resources in the test stack. Edit the Trust Relationship for this role in the IAM console to allow access from CloudFormation. Adding this to the role&#39;s policy statement will accomplish this:</p><pre><code class="language-json">{
  &quot;Effect&quot;: &quot;Allow&quot;,
  &quot;Principal&quot;: {
    &quot;Service&quot;: &quot;cloudformation.amazonaws.com&quot;
  },
  &quot;Action&quot;: &quot;sts:AssumeRole&quot;
}</code></pre><h2><a class="nav-anchor" id="Creating-the-Stack-1" href="#Creating-the-Stack-1">Creating the Stack</a></h2><h3><a class="nav-anchor" id="Variables-1" href="#Variables-1">Variables</a></h3><pre><code class="language-sh"># relative to the package directory
export TEMPLATE=file://test/aws/cwl_test.yml

# the testing user created above
export PUBLIC_CI_USER=CloudWatchLogsJL

# your stack name
# all the Invenia stack names will be CloudWatchLogs-jl-#####, counting up
# do not attempt to give two stacks the same name
export STACK_NAME=CloudWatchLogs-jl-00011</code></pre><h3><a class="nav-anchor" id="Command-1" href="#Command-1">Command</a></h3><p>To create a basic stack with your current profile:</p><pre><code class="language-sh">aws cloudformation create-stack \
    --template-body $TEMPLATE \
    --parameters ParameterKey=PublicCIUser,ParameterValue=$PUBLIC_CI_USER \
    --stack-name $STACK_NAME</code></pre><p>Or if you created a dedicated stack creation role in the optional step above:</p><pre><code class="language-sh">export STACK_ROLE_ARN=arn:aws:iam::263813748431:role/CloudFormationAdmin

aws cloudformation create-stack \
    --template-body $TEMPLATE \
    --capabilities CAPABILITY_NAMED_IAM \
    --role-arn $STACK_ROLE_ARN \
    --parameters ParameterKey=PublicCIUser,ParameterValue=$PUBLIC_CI_USER \
    --stack-name $STACK_NAME</code></pre><p>You can check the status of stack creation with the AWS CloudFormation console or with the AWS CLI.</p><h3><a class="nav-anchor" id="Running-Tests-1" href="#Running-Tests-1">Running Tests</a></h3><p>You must authenticate with the testing user, either by setting <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-environment.html">environment variables</a> or using an AWS profile. The environment variables for Invenia&#39;s stack are privately set in the Travis CI repository settings.</p><p>The stack used to test is versioned with the tests, in the <a href="https://github.com/invenia/CloudWatchLogs.jl/blob/master/test/online.jl"><code>test/online.jl</code></a> file. If you wish to override this for your own testing, set the <code>CLOUDWATCHLOGSJL_STACK_NAME</code> environment variable.</p><p>After this, running Julia tests normally should work!</p><footer><hr/><a class="previous" href="../api/"><span class="direction">Previous</span><span class="title">API</span></a></footer></article></body></html>
