<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Cache for temporaries · TensorOperations.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link href="../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>TensorOperations.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><span class="toctext">Home</span><ul><li><a class="toctext" href="../">TensorOperations.jl</a></li><li><a class="toctext" href="../indexnotation/">Index notation with <code>@tensor</code> macro</a></li><li><a class="toctext" href="../functions/">Functions</a></li><li class="current"><a class="toctext" href>Cache for temporaries</a><ul class="internal"><li><a class="toctext" href="#Enabling-and-disabling-the-cache-1">Enabling and disabling the cache</a></li><li><a class="toctext" href="#Cache-and-multithreading-1">Cache and multithreading</a></li></ul></li><li><a class="toctext" href="../implementation/">Implementation</a></li></ul></li></ul></nav><article id="docs"><header><nav><ul><li>Home</li><li><a href>Cache for temporaries</a></li></ul></nav><hr/><div id="topbar"><span>Cache for temporaries</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="Cache-for-temporaries-1" href="#Cache-for-temporaries-1">Cache for temporaries</a></h1><p>Contracting a sequence of tensors is provably most efficient (in terms of number of computations) by contracting them pairwise. However, this requires that several intermediate results need to be stored. In addition, if the contraction needs to be performed as a BLAS matrix multiplication (which is typically the fastest choice), every tensor typically needs an additional permuted copy that is compatible with the implementation of the contraction as multiplication. All these temporary arrays, which can be large, put a a lot of pressure on Julia&#39;s garbage collector, and the total time spent in the garbage collector can become significant.</p><p>That&#39;s why there is now a functionality to store intermediate results in a package wide cache, where they can be reused upon a next run, either a next iteration if the tensor contraction appears within the body of a loop, or on the next function call if it appears directly within a given function. This mechanism only works with the <code>@tensor</code> macro, not with the function-based interface.</p><p>The <code>@tensor</code> macro expands the given expression and immediately generates the code to create the necessary temporaries. It associates with each of them a random symbol (<code>gensym()</code>) and uses this as an identifier in a package wide global cache structure <code>TensorOperations.cache</code>, the implementation of which is a least-recently used cache dictionary borrowed from the package <a href="https://github.com/JuliaCollections/ LRUCache.jl">LRUCache.jl</a>, but adapted in such a way that it uses a maximum memory size rather than a maximal number of objects. Thereto, it estimates the size of each object added to the cache using <code>Base.summarysize</code> and, when discards objects once a certain memory limit is reached.</p><h2><a class="nav-anchor" id="Enabling-and-disabling-the-cache-1" href="#Enabling-and-disabling-the-cache-1">Enabling and disabling the cache</a></h2><p>The use of the cache can be enabled or disabled using</p><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="TensorOperations.enable_cache" href="#TensorOperations.enable_cache"><code>TensorOperations.enable_cache</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-none">enable_cache(; maxsize::Int = ..., maxrelsize::Real = 0.5)</code></pre><p>(Re)-enable the cache for further use; set the maximal size <code>maxsize</code> (as number of bytes) or relative size <code>maxrelsize</code>, as a fraction between 0 and 1, resulting in <code>maxsize = floor(Int, maxrelsize * Sys.total_memory())</code>.</p></div></div></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="TensorOperations.disable_cache" href="#TensorOperations.disable_cache"><code>TensorOperations.disable_cache</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-none">disable_cache()</code></pre><p>Disable the cache for further use but does not clear its current contents. Also see <a href="#TensorOperations.clear_cache"><code>clear_cache()</code></a></p></div></div></section><p>Furthermore, the current total size of all the objects stored in the cache can be obtained using the method <code>cachesize</code>, and <code>clear_cache</code> can be triggered to release all the objects currently stored in the cache, such that they can be removed by Julia&#39;s garbage collector.</p><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="TensorOperations.cachesize" href="#TensorOperations.cachesize"><code>TensorOperations.cachesize</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-none">cachesize()</code></pre><p>Return the current memory size (in bytes) of all the objects in the cache.</p></div></div></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="TensorOperations.clear_cache" href="#TensorOperations.clear_cache"><code>TensorOperations.clear_cache</code></a> — <span class="docstring-category">Function</span>.</div><div><div><pre><code class="language-none">clear_cache()</code></pre><p>Clear the current contents of the cache.</p></div></div></section><h2><a class="nav-anchor" id="Cache-and-multithreading-1" href="#Cache-and-multithreading-1">Cache and multithreading</a></h2><p>The <code>LRU</code> cache currently used is not thread safe, i.e. if there is any chance that different threads will run tensor expressions using the <code>@tensor</code> environment, you should <code>disable_cache()</code>.</p><footer><hr/><a class="previous" href="../functions/"><span class="direction">Previous</span><span class="title">Functions</span></a><a class="next" href="../implementation/"><span class="direction">Next</span><span class="title">Implementation</span></a></footer></article></body></html>
