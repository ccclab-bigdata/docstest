<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Test Stack Â· AWSCore.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link href="../assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>AWSCore.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="../search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li><a class="toctext" href="../">Home</a></li><li class="current"><a class="toctext" href>Test Stack</a><ul class="internal"><li><a class="toctext" href="#Prerequisites-1">Prerequisites</a></li><li><a class="toctext" href="#Setting-up-the-account-1">Setting up the account</a></li><li><a class="toctext" href="#Creating-the-stack-1">Creating the stack</a></li><li><a class="toctext" href="#Running-tests-1">Running tests</a></li></ul></li></ul></nav><article id="docs"><header><nav><ul><li><a href>Test Stack</a></li></ul></nav><hr/><div id="topbar"><span>Test Stack</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="Setting-up-a-test-environment-1" href="#Setting-up-a-test-environment-1">Setting up a test environment</a></h1><h2><a class="nav-anchor" id="Prerequisites-1" href="#Prerequisites-1">Prerequisites</a></h2><p>An AWS account is required. Setting up the test stack will require permissions for IAM and CloudFormation.</p><p>Some instructions below will use the <a href="https://aws.amazon.com/cli/">AWS CLI</a>.</p><p><a href="https://www.invenia.ca">Invenia</a> has a dedicated AWS account for public CI, the use of which is granted for AWSCore. The actions described below should be performed as an administrator of such an account.</p><h2><a class="nav-anchor" id="Setting-up-the-account-1" href="#Setting-up-the-account-1">Setting up the account</a></h2><h3><a class="nav-anchor" id="Creating-a-test-user-1" href="#Creating-a-test-user-1">Creating a test user</a></h3><p>This user will be responsible for actually running the tests. The user will be passed to CloudFormation on stack creation and given permission to assume the stack&#39;s testing role. This approach allows the same user to be used for multiple testing stacks in the same account, which is useful for iterating on stack design.</p><p>Since the user is given permissions by CloudFormation, it needs no permissions set upon creation. It will, however, need access keys. These should be saved for running tests, ideally as a profile in an <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-config-files.html">AWS credentials file</a>.</p><p>Invenia has set up a user dedicated to the AWSCore project, called AWSCoreJL.</p><h3><a class="nav-anchor" id="Creating-a-dedicated-stack-creation-role-(optional)-1" href="#Creating-a-dedicated-stack-creation-role-(optional)-1">Creating a dedicated stack creation role (optional)</a></h3><p>For greater control and visibility over stack creation, create a dedicated administrator role which will manage the creation of resources in the test stack. Edit the Trust Relationship for this role in the IAM console to allow access from CloudFormation. Adding the following to role&#39;s policy statement will accomplish this:</p><pre><code class="language-yaml">{
  &quot;Effect&quot;: &quot;Allow&quot;,
  &quot;Principal&quot;: {
    &quot;Service&quot;: &quot;cloudformation.amazonaws.com&quot;
  },
  &quot;Action&quot;: &quot;sts:AssumeRole&quot;
}</code></pre><h2><a class="nav-anchor" id="Creating-the-stack-1" href="#Creating-the-stack-1">Creating the stack</a></h2><p>A CloudFormation template resides in the <code>test/aws</code> directory in the AWSCore source tree. This will be used for creating the stack.</p><h3><a class="nav-anchor" id="Environment-variables-1" href="#Environment-variables-1">Environment variables</a></h3><pre><code class="language-sh"># Relative to the root of the package directory
export TEMPLATE=file://test/aws/awscore_test.yml

# The testing user created above
export PUBLIC_CI_USER=AWSCoreJL

# The name of the stack. All stack names used by this package are named using the
# scheme AWSCore-jl-#####, where ##### begins with 00001 and counts up. Do not
# attempt to give two stacks the same name.
export STACK_NAME=AWSCore-jl-00011</code></pre><h3><a class="nav-anchor" id="AWS-CLI-commands-1" href="#AWS-CLI-commands-1">AWS CLI commands</a></h3><p>To create a basic stack using the current profile, use the below. Note that a particular profile can be passed to this command using <code>--profile</code>.</p><pre><code class="language-sh">aws cloudformation create-stack \
    --template-body $TEMPLATE \
    --parameters ParameterKey=PublicCIUser,ParameterValue=$PUBLIC_CI_USER \
    --stack-name $STACK_NAME</code></pre><p>If a dedicated stack creation role was created in the previous step, use this:</p><pre><code class="language-sh">export STACK_ROLE_ARN=arn:aws:iam::263813748431:role/CloudFormationAdmin

aws cloudformation create-stack \
    --template-body $TEMPLATE \
    --capabilities CAPABILITY_NAMED_IAM \
    --role-arn $STACK_ROLE_ARN \
    --parameters ParameterKey=PublicCIUser,ParameterValue=$PUBLIC_CI_USER \
    --stack-name $STACK_NAME</code></pre><p>The status of the stack creation can be verified using the AWS CloudFormation console or with the AWS CLI.</p><h2><a class="nav-anchor" id="Running-tests-1" href="#Running-tests-1">Running tests</a></h2><p>The testing user must be authenticated, either through the use of <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-environment.html">environment variables</a> or using an AWS profile. The environment variables for Invenia&#39;s stack are privately in the Travis CI repository settings.</p><p>Running Julia tests normally should now work!</p><footer><hr/><a class="previous" href="../"><span class="direction">Previous</span><span class="title">Home</span></a></footer></article></body></html>
